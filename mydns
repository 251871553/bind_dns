import dns.resolver
import dns.tsigkeyring
import dns.update
import dns.query
import dns.update
import dns.zone

class mydns_api:
    def __init__(self):
        self.keyring = dns.tsigkeyring.from_text({
            'local-ddns': 'ASeOyC3PrK2N60JDXAKvwMRIGnchGrvsC4m9cferyIs='
        })
        self.sha_type='hmac-sha256'
        self.name_server_addr = '192.168.235.128'
        self.name_server_port = 53

    def zone_list(self,zone_name):
        z = dns.zone.from_xfr(dns.query.xfr(self.name_server_addr, zone_name))
        names = z.nodes.keys()
        for n in names:
            record = z[n].to_text(n)
            print(record)

    def search_record(self,search_record,record_type):
        dns_query = dns.message.make_query(search_record, record_type)
        response = dns.query.udp(dns_query, self.name_server_addr, port=self.name_server_port)
        #print(response.answer)
        if response.answer:
           for i in response.answer:
               #print(i)
               return True
        else:
               #print('not found')
               return False

    def add_record(self,domain_zone,domain_name,ttl,record_type,record_value):
        if self.search_record(domain_name+'.'+domain_zone,record_type):
            return {'code':'1','message':'record aleady exit'}
        else:
            update = dns.update.Update(domain_zone, keyring=self.keyring, keyalgorithm=self.sha_type)
            update.add(domain_name, ttl, record_type, record_value)
            response = dns.query.tcp(update, self.name_server_addr)
            return {'code': 0,'message':'ok'}

    def edit_record(self,domain_zone,domain_name,ttl,record_type,record_value):
        update = dns.update.Update(domain_zone, keyring=self.keyring, keyalgorithm=self.sha_type)
        update.replace(domain_name, ttl, record_type, record_value)
        response = dns.query.tcp(update, self.name_server_addr)
        if self.search_record(domain_name + '.' + domain_zone, record_type):
            return {'code': 0, 'message': 'ok'}
        else:
            return {'code': '2', 'message': 'not edit'}

    def del_record(self,domain_zone,domain_name,record_type):
        update = dns.update.Update(domain_zone, keyring=self.keyring, keyalgorithm=self.sha_type)
        update.delete(domain_name)
        response = dns.query.tcp(update, self.name_server_addr)
        if self.search_record(domain_name + '.' + domain_zone, record_type):
            return {'code': 3, 'message': 'not delete sucess'}
        else:
            return {'code': '0', 'message': 'ok'}



if __name__ == '__main__':
  my_ops=mydns_api()
  my_ops.zone_list('test.com')
  #my_ops.search_record('db3.test.com','a')
  #print(my_ops.add_record('test.com','web1',300,'cname','www.baidu.com'))
 # print(my_ops.edit_record('test.com','db3',300,'a','3.1.1.1'))
  #print(my_ops.del_record('test.com','db5','a'))
